# Authentik SSO Integration Setup for MockFactory

This guide explains how to configure Authentik to provide SSO authentication for MockFactory.io.

## Prerequisites

- Authentik instance running (e.g., `https://authentik.yourcompany.com`)
- Admin access to Authentik
- MockFactory.io deployed and accessible

## Step 1: Create OAuth2/OIDC Provider in Authentik

1. **Log into Authentik Admin Panel**
   - Navigate to your Authentik instance
   - Go to **Admin Interface**

2. **Create a new Provider**
   - Go to **Applications** → **Providers**
   - Click **Create**
   - Select **OAuth2/OpenID Provider**

3. **Configure Provider Settings**:
   ```
   Name: MockFactory OAuth2
   Authorization flow: default-authentication-flow (or your custom flow)
   Client type: Confidential
   Client ID: <auto-generated> (copy this)
   Client Secret: <auto-generated> (copy this)
   Redirect URIs/Origins:
     - https://mockfactory.io/api/v1/auth/sso/callback
     - http://localhost:8000/api/v1/auth/sso/callback (for development)
   Scopes: openid, email, profile
   Subject mode: Based on the User's ID
   Include claims in id_token: ✓ (checked)
   Issuer mode: Per Provider
   ```

4. **Save the Provider**

## Step 2: Create Application in Authentik

1. **Create Application**
   - Go to **Applications** → **Applications**
   - Click **Create**

2. **Configure Application**:
   ```
   Name: MockFactory
   Slug: mockfactory
   Provider: MockFactory OAuth2 (select the provider from Step 1)
   Launch URL: https://mockfactory.io
   Icon: (optional - upload MockFactory logo)
   ```

3. **Save the Application**

## Step 3: Configure User Groups for Tiers

MockFactory uses Authentik groups to determine user tiers:

1. **Create Groups** (if they don't exist)
   - Go to **Directory** → **Groups**
   - Create the following groups:

   ```
   Group: students
   - Description: Student tier users (25 executions/month)

   Group: afterdark-employees
   - Description: After Dark Systems employees (unlimited)

   Group: employees
   - Description: General employee group (unlimited)
   ```

2. **Assign Users to Groups**
   - Go to **Directory** → **Users**
   - Edit users and add them to appropriate groups

## Step 4: Configure MockFactory Environment

Update your MockFactory `.env` file with Authentik credentials:

```bash
# Authentik OAuth2/OIDC
OAUTH_CLIENT_ID=<your-client-id-from-step-1>
OAUTH_CLIENT_SECRET=<your-client-secret-from-step-1>
OAUTH_AUTHORIZE_URL=https://authentik.yourcompany.com/application/o/authorize/
OAUTH_TOKEN_URL=https://authentik.yourcompany.com/application/o/token/
OAUTH_USERINFO_URL=https://authentik.yourcompany.com/application/o/userinfo/
OAUTH_LOGOUT_URL=https://authentik.yourcompany.com/application/o/mockfactory/end-session/
OAUTH_PROVIDER_NAME=Authentik
```

**Replace `authentik.yourcompany.com` with your actual Authentik domain.**

## Step 5: Test SSO Integration

1. **Restart MockFactory**
   ```bash
   docker-compose restart api
   ```

2. **Test Login Flow**
   - Go to https://mockfactory.io
   - Click **SSO Login**
   - You should be redirected to Authentik login
   - After authentication, you should be redirected back to MockFactory

3. **Verify User Creation**
   - Check that user is created in MockFactory database
   - Verify correct tier assignment based on groups

## User Tier Assignment Logic

MockFactory determines user tiers based on Authentik groups:

| Authentik Group | MockFactory Tier | Executions/Month |
|----------------|------------------|------------------|
| `employees` or `afterdark-employees` | Employee | Unlimited |
| `students` | Student | 25 |
| No group | Beginner | 10 |

### Priority Order:
1. If user is in `employees` or `afterdark-employees` → **Employee tier**
2. Else if user is in `students` → **Student tier**
3. Else → **Beginner tier**

## Advanced Configuration

### Custom Authentication Flow

To create a custom authentication flow in Authentik:

1. Go to **Flows & Stages** → **Flows**
2. Create a new flow or copy the default
3. Add stages for:
   - Email verification
   - MFA (optional)
   - Consent (optional)
   - Custom fields (department, student ID, etc.)

4. Update the Provider to use your custom flow

### Attribute Mapping

To pass custom attributes to MockFactory:

1. Go to your Provider settings
2. Navigate to **Property Mappings**
3. Add custom scope mappings:

```python
# Example: Pass department to MockFactory
return {
    "department": request.user.attributes.get("department", "")
}
```

### Group Sync

Ensure groups are included in the OIDC token:

1. Go to **Customization** → **Property Mappings**
2. Find or create "OpenID 'Groups'" mapping
3. Ensure it's enabled and added to your provider

```python
# Default groups mapping
return {
    "groups": [group.name for group in request.user.ak_groups.all()]
}
```

## Troubleshooting

### Issue: Redirect URI mismatch

**Error**: `redirect_uri_mismatch`

**Solution**:
- Verify the redirect URI in Authentik matches exactly:
  - `https://mockfactory.io/api/v1/auth/sso/callback`
- No trailing slashes
- Use HTTPS in production

### Issue: User not getting correct tier

**Solution**:
- Check user's groups in Authentik
- Verify group names match exactly: `students`, `employees`, `afterdark-employees`
- Check MockFactory logs for group membership

### Issue: Token validation fails

**Solution**:
- Verify CLIENT_ID and CLIENT_SECRET are correct
- Check that token URL is accessible from MockFactory server
- Ensure Authentik is using HTTPS in production

### Issue: User info not returned

**Solution**:
- Verify scopes include `openid`, `email`, `profile`
- Check that "Include claims in id_token" is enabled
- Ensure user has email set in Authentik

## Security Best Practices

1. **Use HTTPS Only** in production
2. **Rotate Client Secrets** regularly
3. **Enable MFA** in Authentik for all users
4. **Audit Logs**: Review Authentik logs regularly
5. **Scope Limitation**: Only request necessary scopes
6. **Session Management**: Configure appropriate session timeouts

## Testing with Development Environment

For local testing:

```bash
# .env for development
OAUTH_AUTHORIZE_URL=http://localhost:9000/application/o/authorize/
OAUTH_TOKEN_URL=http://localhost:9000/application/o/token/
OAUTH_USERINFO_URL=http://localhost:9000/application/o/userinfo/
```

Add to Authentik redirect URIs:
```
http://localhost:8000/api/v1/auth/sso/callback
```

## Support

For issues with:
- **Authentik Configuration**: Check Authentik documentation
- **MockFactory Integration**: Contact support@afterdarksystems.com
- **Tier Assignment**: Review group membership in Authentik

## References

- [Authentik OAuth2/OIDC Documentation](https://goauthentik.io/docs/providers/oauth2/)
- [OpenID Connect Specification](https://openid.net/connect/)
- [MockFactory API Documentation](https://mockfactory.io/docs)
